
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The Unity Machine Learning Agents Toolkit (ML-Agents) is an open-source project that enables games and simulations to serve as environments for training intelligent agents.">
      
      
        <meta name="author" content="Unity Technologies">
      
      
        <link rel="canonical" href="https://unity-technologies.github.io/ml-agents/Tutorial-Custom-Trainer-Plugin/">
      
      <link rel="icon" href="../images/unity-logo-black.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Custom Trainer Plugin - Unity ML-Agents Toolkit</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
          
          
          <meta name="theme-color" content="#4cae4f">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="light-green">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-1-write-your-custom-trainer-class" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Unity ML-Agents Toolkit" class="md-header__button md-logo" aria-label="Unity ML-Agents Toolkit" data-md-component="logo">
      
  <img src="../images/unity-logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Unity ML-Agents Toolkit
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Custom Trainer Plugin
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Unity-Technologies/ml-agents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Unity ML-Agents Toolkit" class="md-nav__button md-logo" aria-label="Unity ML-Agents Toolkit" data-md-component="logo">
      
  <img src="../images/unity-logo.png" alt="logo">

    </a>
    Unity ML-Agents Toolkit
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Unity-Technologies/ml-agents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ML-Agents-Overview/" class="md-nav__link">
        ML-Agents Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ML-Agents-Toolkit-Documentation/" class="md-nav__link">
        Toolkit Documentation
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Background
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Background" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Background
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Background-Machine-Learning/" class="md-nav__link">
        Machine Learning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Background-PyTorch/" class="md-nav__link">
        PyTorch
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Background-Unity/" class="md-nav__link">
        Unity
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Interfacing with Unity Builds
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Interfacing with Unity Builds" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Interfacing with Unity Builds
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-Gym-API/" class="md-nav__link">
        Getting started with the Gym API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-PettingZoo-API/" class="md-nav__link">
        Getting started with the PettingZoo API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-LLAPI/" class="md-nav__link">
        Getting started with the LLAPI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Python API Docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Python API Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Python API Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-Gym-API-Documentation/" class="md-nav__link">
        Gym API Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-PettingZoo-API-Documentation/" class="md-nav__link">
        Petting Zoo Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-LLAPI-Documentation/" class="md-nav__link">
        LLAPI Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Python-On-Off-Policy-Trainer-Documentation/" class="md-nav__link">
        On/Off Policy Trainer
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Custom Trainer Plugin
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Custom Trainer Plugin
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-write-your-custom-trainer-class" class="md-nav__link">
    Step 1: Write your custom trainer class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-implement-your-custom-optimizer-for-the-trainer" class="md-nav__link">
    Step 2: implement your custom optimizer for the trainer.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-integrate-your-custom-trainer-into-the-plugin-system" class="md-nav__link">
    Step 3: Integrate your custom trainer into the plugin system
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-install-your-custom-trainer-and-run-training" class="md-nav__link">
    Step 4: Install your custom trainer and run training:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-your-implementations" class="md-nav__link">
    Validate your implementations:
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../FAQ/" class="md-nav__link">
        FAQs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Limitations/" class="md-nav__link">
        Limitations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Migrating/" class="md-nav__link">
        Migrating
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Versioning/" class="md-nav__link">
        Versioning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-write-your-custom-trainer-class" class="md-nav__link">
    Step 1: Write your custom trainer class
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-implement-your-custom-optimizer-for-the-trainer" class="md-nav__link">
    Step 2: implement your custom optimizer for the trainer.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-integrate-your-custom-trainer-into-the-plugin-system" class="md-nav__link">
    Step 3: Integrate your custom trainer into the plugin system
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-install-your-custom-trainer-and-run-training" class="md-nav__link">
    Step 4: Install your custom trainer and run training:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-your-implementations" class="md-nav__link">
    Validate your implementations:
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/Unity-Technologies/ml-agents/edit/main/docs/Tutorial-Custom-Trainer-Plugin.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Custom Trainer Plugin</h1>

<h3 id="step-1-write-your-custom-trainer-class">Step 1: Write your custom trainer class</h3>
<p>Before you start writing your code, make sure to use your favorite environment management tool(e.g. <code>venv</code> or <code>conda</code>) to create and activate a Python virtual environment. The following command uses <code>conda</code>, but other tools work similarly:</p>
<pre><code class="language-shell">conda create -n trainer-env python=3.8.13
conda activate trainer-env
</code></pre>
<p>Users of the plug-in system are responsible for implementing the trainer class subject to the API standard. Let us follow an example by implementing a custom trainer named "YourCustomTrainer". You can either extend <code>OnPolicyTrainer</code> or <code>OffPolicyTrainer</code> classes depending on the training strategies you choose.</p>
<p>Please refer to the internal <a href="../ml-agents/mlagents/trainers/ppo/trainer.py">PPO implementation</a> for a complete code example. We will not provide a workable code in the document. The purpose of the tutorial is to introduce you to the core components and interfaces of our plugin framework. We use code snippets and patterns to demonstrate the control and data flow.</p>
<p>Your custom trainers are responsible for collecting experiences and training the models. Your custom trainer class acts like a co-ordinator to the policy and optimizer. To start implementing methods in the class, create a policy class objects from method <code>create_policy</code>:</p>
<pre><code class="language-python">def create_policy(
    self, parsed_behavior_id: BehaviorIdentifiers, behavior_spec: BehaviorSpec
) -&gt; TorchPolicy:

    actor_cls: Union[Type[SimpleActor], Type[SharedActorCritic]] = SimpleActor
    actor_kwargs: Dict[str, Any] = {
        &quot;conditional_sigma&quot;: False,
        &quot;tanh_squash&quot;: False,
    }
    if self.shared_critic:
        reward_signal_configs = self.trainer_settings.reward_signals
        reward_signal_names = [
            key.value for key, _ in reward_signal_configs.items()
        ]
        actor_cls = SharedActorCritic
        actor_kwargs.update({&quot;stream_names&quot;: reward_signal_names})

    policy = TorchPolicy(
        self.seed,
        behavior_spec,
        self.trainer_settings.network_settings,
        actor_cls,
        actor_kwargs,
    )
    return policy

</code></pre>
<p>Depending on whether you use shared or separate network architecture for your policy, we provide <code>SimpleActor</code> and <code>SharedActorCritic</code> from <code>mlagents.trainers.torch_entities.networks</code> that you can choose from. In our example above, we use a <code>SimpleActor</code>.</p>
<p>Next, create an optimizer class object from <code>create_optimizer</code> method and connect it to the policy object you created above:</p>
<pre><code class="language-python">def create_optimizer(self) -&gt; TorchOptimizer:
    return TorchPPOOptimizer(  # type: ignore
        cast(TorchPolicy, self.policy), self.trainer_settings  # type: ignore
    )  # type: ignore

</code></pre>
<p>There are a couple of abstract methods(<code>_process_trajectory</code> and <code>_update_policy</code>) inherited from <code>RLTrainer</code> that you need to implement in your custom trainer class. <code>_process_trajectory</code> takes a trajectory and processes it, putting it into the update buffer. Processing involves calculating value and advantage targets for the model updating step. Given input <code>trajectory: Trajectory</code>, users are responsible for processing the data in the trajectory and append <code>agent_buffer_trajectory</code> to the back of the update buffer by calling <code>self._append_to_update_buffer(agent_buffer_trajectory)</code>, whose output will be used in updating the model in <code>optimizer</code> class.</p>
<p>A typical <code>_process_trajectory</code> function(incomplete) will convert a trajectory object to an agent buffer then get all value estimates from the trajectory by calling <code>self.optimizer.get_trajectory_value_estimates</code>. From the returned dictionary of value estimates we extract reward signals keyed by their names:</p>
<pre><code class="language-python">def _process_trajectory(self, trajectory: Trajectory) -&gt; None:
    super()._process_trajectory(trajectory)
    agent_id = trajectory.agent_id  # All the agents should have the same ID

    agent_buffer_trajectory = trajectory.to_agentbuffer()

    # Get all value estimates
    (
        value_estimates,
        value_next,
        value_memories,
    ) =  self.optimizer.get_trajectory_value_estimates(
        agent_buffer_trajectory,
        trajectory.next_obs,
        trajectory.done_reached and not trajectory.interrupted,
    )

    for name, v in value_estimates.items():
        agent_buffer_trajectory[RewardSignalUtil.value_estimates_key(name)].extend(
            v
        )
        self._stats_reporter.add_stat(
            f&quot;Policy/{self.optimizer.reward_signals[name].name.capitalize()} Value Estimate&quot;,
            np.mean(v),
        )

    # Evaluate all reward functions
    self.collected_rewards[&quot;environment&quot;][agent_id] += np.sum(
        agent_buffer_trajectory[BufferKey.ENVIRONMENT_REWARDS]
    )
    for name, reward_signal in self.optimizer.reward_signals.items():
        evaluate_result = (
            reward_signal.evaluate(agent_buffer_trajectory) * reward_signal.strength
        )
        agent_buffer_trajectory[RewardSignalUtil.rewards_key(name)].extend(
            evaluate_result
        )
        # Report the reward signals
        self.collected_rewards[name][agent_id] += np.sum(evaluate_result)

    self._append_to_update_buffer(agent_buffer_trajectory)

</code></pre>
<p>A trajectory will be a list of dictionaries of strings mapped to <code>Anything</code>. When calling <code>forward</code> on a policy, the argument will include an “experience” dictionary from the last step. The <code>forward</code> method will generate an action and the next “experience” dictionary. Examples of fields in the “experience” dictionary include observation, action, reward, done status, group_reward, LSTM memory state, etc.</p>
<h3 id="step-2-implement-your-custom-optimizer-for-the-trainer">Step 2: implement your custom optimizer for the trainer.</h3>
<p>We will show you an example we implemented - <code>class TorchPPOOptimizer(TorchOptimizer)</code>, which takes a Policy and a Dict of trainer parameters and creates an Optimizer that connects to the policy. Your optimizer should include a value estimator and a loss function in the <code>update</code> method.</p>
<p>Before writing your optimizer class, first define setting class <code>class PPOSettings(OnPolicyHyperparamSettings)</code> for your custom optimizer:</p>
<pre><code class="language-python">class PPOSettings(OnPolicyHyperparamSettings):
    beta: float = 5.0e-3
    epsilon: float = 0.2
    lambd: float = 0.95
    num_epoch: int = 3
    shared_critic: bool = False
    learning_rate_schedule: ScheduleType = ScheduleType.LINEAR
    beta_schedule: ScheduleType = ScheduleType.LINEAR
    epsilon_schedule: ScheduleType = ScheduleType.LINEAR

</code></pre>
<p>You should implement <code>update</code> function following interface:</p>
<pre><code class="language-python">def update(self, batch: AgentBuffer, num_sequences: int) -&gt; Dict[str, float]:

</code></pre>
<p>In which losses and other metrics are calculated from an <code>AgentBuffer</code> that is generated from your trainer class, depending on which model you choose to implement the loss functions will be different. In our case we calculate value loss from critic and trust region policy loss. A typical pattern(incomplete) of the calculations will look like the following:</p>
<pre><code class="language-python">run_out = self.policy.actor.get_stats(
    current_obs,
    actions,
    masks=act_masks,
    memories=memories,
    sequence_length=self.policy.sequence_length,
)

log_probs = run_out[&quot;log_probs&quot;]
entropy = run_out[&quot;entropy&quot;]

values, _ = self.critic.critic_pass(
    current_obs,
    memories=value_memories,
    sequence_length=self.policy.sequence_length,
)
policy_loss = ModelUtils.trust_region_policy_loss(
    ModelUtils.list_to_tensor(batch[BufferKey.ADVANTAGES]),
    log_probs,
    old_log_probs,
    loss_masks,
    decay_eps,
)
loss = (
    policy_loss
    + 0.5 * value_loss
    - decay_bet * ModelUtils.masked_mean(entropy, loss_masks)
)

</code></pre>
<p>Finally update the model and return the a dictionary including calculated losses and updated decay learning rate:</p>
<pre><code class="language-python">ModelUtils.update_learning_rate(self.optimizer, decay_lr)
self.optimizer.zero_grad()
loss.backward()

self.optimizer.step()
update_stats = {
    &quot;Losses/Policy Loss&quot;: torch.abs(policy_loss).item(),
    &quot;Losses/Value Loss&quot;: value_loss.item(),
    &quot;Policy/Learning Rate&quot;: decay_lr,
    &quot;Policy/Epsilon&quot;: decay_eps,
    &quot;Policy/Beta&quot;: decay_bet,
}

</code></pre>
<h3 id="step-3-integrate-your-custom-trainer-into-the-plugin-system">Step 3: Integrate your custom trainer into the plugin system</h3>
<p>By integrating a custom trainer into the plugin system, a user can use their published packages which have their implementations. To do that, you need to add a setup.py file. In the call to setup(), you'll need to add to the entry_points dictionary for each plugin interface that you implement. The form of this is {entry point name}={plugin module}:{plugin function}. For example:</p>
<pre><code class="language-python">entry_points={
        ML_AGENTS_TRAINER_TYPE: [
            &quot;your_trainer_type=your_package.your_custom_trainer:get_type_and_setting&quot;
        ]
    },
</code></pre>
<p>Some key elements in the code:</p>
<pre><code>ML_AGENTS_TRAINER_TYPE: a string constant for trainer type
your_trainer_type: name your trainer type, used in configuration file
your_package: your pip installable package containing custom trainer implementation
</code></pre>
<p>Also define <code>get_type_and_setting</code> method in <code>YourCustomTrainer</code> class:</p>
<pre><code class="language-python">def get_type_and_setting():
    return {YourCustomTrainer.get_trainer_name(): YourCustomTrainer}, {
        YourCustomTrainer.get_trainer_name(): YourCustomSetting
    }

</code></pre>
<p>Finally, specify trainer type in the config file:</p>
<pre><code class="language-python">behaviors:
  3DBall:
    trainer_type: your_trainer_type
...
</code></pre>
<h3 id="step-4-install-your-custom-trainer-and-run-training">Step 4: Install your custom trainer and run training:</h3>
<p>Before installing your custom trainer package, make sure you have <code>ml-agents-env</code> and <code>ml-agents</code> installed</p>
<pre><code class="language-shell">pip3 install -e ./ml-agents-envs &amp;&amp; pip3 install -e ./ml-agents
</code></pre>
<p>Install your cutom trainer package(if your package is pip installable):</p>
<pre><code class="language-shell">pip3 install your_custom_package
</code></pre>
<p>Or follow our internal implementations:</p>
<pre><code class="language-shell">pip3 install -e ./ml-agents-trainer-plugin
</code></pre>
<p>Following the previous installations your package is added as an entrypoint and you can use a config file with new
trainers:</p>
<pre><code class="language-shell">mlagents-learn ml-agents-trainer-plugin/mlagents_trainer_plugin/a2c/a2c_3DBall.yaml --run-id &lt;run-id-name&gt;
--env &lt;env-executable&gt;
</code></pre>
<h3 id="validate-your-implementations">Validate your implementations:</h3>
<p>Create a clean Python environment with Python 3.8+ and activate it before you start, if you haven't done so already:</p>
<pre><code class="language-shell">conda create -n trainer-env python=3.8.13
conda activate trainer-env
</code></pre>
<p>Make sure you follow previous steps and install all required packages. We are testing internal implementations in this tutorial, but ML-Agents users can run similar validations once they have their own implementations installed:</p>
<pre><code class="language-shell">pip3 install -e ./ml-agents-envs &amp;&amp; pip3 install -e ./ml-agents
pip3 install -e ./ml-agents-trainer-plugin
</code></pre>
<p>Once your package is added as an <code>entrypoint</code>, you can add to the config file the new trainer type. Check if trainer type is specified in the config file <code>a2c_3DBall.yaml</code>:</p>
<pre><code>trainer_type: a2c
</code></pre>
<p>Test if custom trainer package is installed by running:</p>
<pre><code class="language-shell">mlagents-learn ml-agents-trainer-plugin/mlagents_trainer_plugin/a2c/a2c_3DBall.yaml --run-id test-trainer
</code></pre>
<p>You can also list all trainers installed in the registry. Type <code>python</code> in your shell to open a REPL session. Run the python code below, you should be able to see all trainer types currently installed:</p>
<pre><code class="language-python">&gt;&gt;&gt; import pkg_resources
&gt;&gt;&gt; for entry in pkg_resources.iter_entry_points('mlagents.trainer_type'):
...     print(entry)
...
default = mlagents.plugins.trainer_type:get_default_trainer_types
a2c = mlagents_trainer_plugin.a2c.a2c_trainer:get_type_and_setting
dqn = mlagents_trainer_plugin.dqn.dqn_trainer:get_type_and_setting
</code></pre>
<p>If it is properly installed, you will see Unity logo and message indicating training will start:</p>
<pre><code>[INFO] Listening on port 5004. Start training by pressing the Play button in the Unity Editor.
</code></pre>
<p>If you see the following error message, it could be due to trainer type is wrong or the trainer type specified is not installed:</p>
<pre><code class="language-shell">mlagents.trainers.exception.TrainerConfigError: Invalid trainer type a2c was found
</code></pre>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../Python-On-Off-Policy-Trainer-Documentation/" class="md-footer__link md-footer__link--prev" aria-label="Previous: On/Off Policy Trainer" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              On/Off Policy Trainer
            </div>
          </div>
        </a>
      
      
        
        <a href="../FAQ/" class="md-footer__link md-footer__link--next" aria-label="Next: FAQs" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              FAQs
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      com.unity.ml-agents copyright © 2017 - 2022 Unity Technologies
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>